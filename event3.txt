local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local VirtualInputManager = game:GetService("VirtualInputManager")

local LocalPlayer = Players.LocalPlayer
local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
local HRP = Character:WaitForChild("HumanoidRootPart")
local Handler = Character:WaitForChild("PlayerHandler"):WaitForChild("HandlerEvent")
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")

-- === CONFIG ===
local questName = "Summer's Eclipse"
local questPath = function()
	return PlayerGui.Main.QuestAlertFrame.QuestGUI:FindFirstChild(questName)
end

local targetQueue = {
	{ui = "Water Specialist Lv.80", npc = "Water Specialist Lv.80"},
	{ui = "Festive Soldier Lv.80", npc = "Festive Soldier Lv.80"},
	{ui = "Festive Elite Lv.90", npc = "Festive Elite Lv.90"},
}

-- === UTILS ===
local function fireDialogue(choice)
	local args = {{ Choice = choice }}
	ReplicatedStorage.Remote.Event.Dialogue:FireServer(unpack(args))
end

local function fireRemote(args, remoteName)
	ReplicatedStorage.Remote.Event[remoteName]:FireServer(unpack(args))
end

local function fireRiderManager(args)
	ReplicatedStorage.Remote.Event.RiderManager:FireServer(unpack(args))
end

local function m1Attack(pos)
	local args = {{
		CombatAction = true,
		LightAttack = true,
		MouseData = CFrame.new(pos)
	}}
	Handler:FireServer(unpack(args))
end

local function useSkill(pos)
	local args = {{
		Skill = true,
		AttackType = "Down",
		Key = "E",
		MouseData = CFrame.new(pos)
	}}
	Handler:FireServer(unpack(args))
end

local function clickQuestButton()
	local btn = PlayerGui:WaitForChild("Main"):WaitForChild("FunctionFrame"):WaitForChild("QuestButton")
	if btn and btn.AbsolutePosition then
		local pos = btn.AbsolutePosition + (btn.AbsoluteSize / 2)
		VirtualInputManager:SendMouseButtonEvent(pos.X, pos.Y, 0, true, game, 0)
		task.wait()
		VirtualInputManager:SendMouseButtonEvent(pos.X, pos.Y, 0, false, game, 0)
	end
end

local function tpTo(position)
	LocalPlayer.Character:MoveTo(position)
end

-- === SUMMER QUEST LOGIC ===
local function startQuest()
	tpTo(Vector3.new(-969, 26, -56))
	task.wait(2)
	fireclickdetector(Workspace.NPC.Sommic.ClickDetector)
	task.wait(1)
	fireDialogue("[ Event Quest ]")
	task.wait(0.5)
	fireDialogue("Exit")
end

local function completeQuest()
	fireclickdetector(Workspace.NPC.Sommic.ClickDetector)
	task.wait(1)
	fireDialogue("[ Event Quest ]")
	task.wait(0.5)
	fireDialogue("Yep!")
	task.wait(0.5)
	fireDialogue("Exit")
end

local function waitForQuestText()
	clickQuestButton()
	repeat task.wait(0.5)
	until questPath() and questPath().Text:match("%(.-/.-%)") or questPath().Text:find("Quest Completed")
end

local function isQuestComplete()
	local q = questPath()
	return q and q.Text and q.Text:find("Quest Completed")
end

local function killTarget(npcName)
	local npc = Workspace.Lives:FindFirstChild(npcName)
	if npc and npc:FindFirstChild("HumanoidRootPart") then
		local targetHRP = npc.HumanoidRootPart
		repeat
			Character:MoveTo(targetHRP.Position + Vector3.new(0, -4, 0))
			m1Attack(targetHRP.Position)
			useSkill(targetHRP.Position)
			task.wait(0.25)
		until not npc:FindFirstChild("Humanoid") or npc.Humanoid.Health <= 0
	end
end

-- === DESIRE GAMES SPECIAL BOSS ===
local function desireQuestLabel()
	local gui = PlayerGui.Main.QuestAlertFrame.QuestGUI:FindFirstChild("Desire Games")
	return gui and gui.Text or nil
end

local function handlePossessedRider()
	-- Check if the quest is already completed (GUI label)
	local questText = desireQuestLabel()
	if questText and questText:find("Quest Completed") then
		tpTo(Vector3.new(-1555, 23, 824))
		task.wait(2)
		fireclickdetector(Workspace.NPC.ARKReplicator.ClickDetector)
		task.wait(1)
		fireRemote({{ Choice = "[ Desire Games ]" }}, "Dialogue")
		task.wait(0.5)
		fireRemote({{ Choice = "Completed it." }}, "Dialogue")
		task.wait(0.5)
		fireRemote({{ Exit = true }}, "Dialogue")
		return -- âœ… STOP here, don't touch boss
	end

	-- If no boss spawned, skip
	local rider = Workspace.Lives:FindFirstChild("Possessed Rider Lv.90")
	if not rider then return end

	-- Start the quest
	tpTo(Vector3.new(-1555, 23, 824))
	task.wait(0.5)
	fireclickdetector(Workspace.NPC.ARKReplicator.ClickDetector)
	task.wait(1)
	fireRemote({{ Choice = "[ Desire Games ]" }}, "Dialogue")
	task.wait(0.5)
	fireRemote({{ Exit = true }}, "Dialogue")
	task.wait(0.5)
	fireRiderManager({ "War" }) -- PvP

	-- Wait for quest GUI to appear
	repeat task.wait(0.5) until desireQuestLabel()

	-- Fight boss
	killTarget("Possessed Rider Lv.90")
	task.wait(0.5)

	-- Open chest
	local chest = Workspace:FindFirstChild("EFX") and Workspace.EFX:FindFirstChild("InteractableChest") and Workspace.EFX.InteractableChest:FindFirstChild("ClaimChest")
	if chest and chest:IsA("ProximityPrompt") then
		fireproximityprompt(chest, 0)
	end
	task.wait(0.5)

	-- Switch back to PvE
	fireRiderManager({ "War" })

	-- Wait for GUI to confirm quest completion
	for _ = 1, 20 do
		questText = desireQuestLabel()
		if questText and questText:find("Quest Completed") then break end
		task.wait(0.5)
	end

	-- Turn in
	tpTo(Vector3.new(-1555, 23, 824))
	task.wait(0.5)
	fireclickdetector(Workspace.NPC.ARKReplicator.ClickDetector)
	task.wait(1)
	fireRemote({{ Choice = "[ Desire Games ]" }}, "Dialogue")
	task.wait(0.5)
	fireRemote({{ Choice = "Completed it." }}, "Dialogue")
	task.wait(0.5)
	fireRemote({{ Exit = true }}, "Dialogue")
end




-- === MAIN LOOP ===
while true do
	-- Check and kill Possessed Rider first
	handlePossessedRider()

	-- Then run regular Summer's Eclipse quest
	startQuest()
	waitForQuestText()

	local index = 1
	while not isQuestComplete() do
		local target = targetQueue[index]
		if target then
			killTarget(target.npc)
			index = (index % #targetQueue) + 1
		end
		task.wait(0.5)
		clickQuestButton()
	end

	completeQuest()
end
